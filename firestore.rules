rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // üîß HELPER FUNCTIONS
    // ==========================================
    
    // V√©rifie si l'utilisateur est connect√©
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // R√©cup√®re le r√¥le de l'utilisateur connect√©
    function getUserRole() {
      return get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role;
    }
    
    // V√©rifie si l'utilisateur est admin
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }
    
    // V√©rifie si l'utilisateur est propri√©taire du restaurant
    function isRestaurantOwner(restaurantId) {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/restaurants/$(restaurantId)).data.ownerId == request.auth.uid;
    }
    
    // ==========================================
    // üë§ PROFILS UTILISATEURS
    // ==========================================
    match /user/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow create: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow update: if isAuthenticated() && (
        (request.auth.uid == userId && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role'])) 
        || isAdmin()
      );
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // üçΩÔ∏è RESTAURANTS
    // ==========================================
    match /restaurants/{restaurantId} {
      allow read: if true;
      allow create: if isAdmin();
      allow update: if isRestaurantOwner(restaurantId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // üçî PLATS
    // ==========================================
    match /dishes/{dishId} {
      allow read: if true;
      allow create: if isAuthenticated() && (
        isRestaurantOwner(request.resource.data.restaurantId) || isAdmin()
      );
      allow update: if isAuthenticated() && (
        isRestaurantOwner(resource.data.restaurantId) || isAdmin()
      );
      allow delete: if isAuthenticated() && (
        isRestaurantOwner(resource.data.restaurantId) || isAdmin()
      );
    }
    
    // ==========================================
    // üéØ PROMOTIONS (NOUVEAU)
    // ==========================================
    match /promotions/{promoId} {
      // Tout le monde peut voir les promotions (affichage dans l'app mobile)
      allow read: if true;
      
      // Le propri√©taire du restaurant peut cr√©er des promotions
      allow create: if isAuthenticated() && (
        isRestaurantOwner(request.resource.data.restaurantId) || isAdmin()
      );
      
      // Le propri√©taire du restaurant peut modifier ses promotions
      allow update: if isAuthenticated() && (
        isRestaurantOwner(resource.data.restaurantId) || isAdmin()
      );
      
      // Le propri√©taire du restaurant peut supprimer ses promotions
      allow delete: if isAuthenticated() && (
        isRestaurantOwner(resource.data.restaurantId) || isAdmin()
      );
    }
    
    // ==========================================
    // üì¶ COMMANDES
    // ==========================================
    match /orders/{orderId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == resource.data.userId ||
        request.auth.uid == resource.data.driverId ||
        isRestaurantOwner(resource.data.restaurantId) ||
        isAdmin()
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        request.auth.uid == resource.data.userId ||
        request.auth.uid == resource.data.driverId ||
        isRestaurantOwner(resource.data.restaurantId) ||
        getUserRole() == 'driver' ||
        isAdmin()
      );
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // ‚≠ê NOTATIONS
    // ==========================================
    match /ratings/{ratingId} {
      allow read: if true;
      allow create: if isAuthenticated() 
                    && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() 
                            && resource.data.userId == request.auth.uid;
    }
    
    // ==========================================
    // üöó LIVREURS
    // ==========================================
    match /drivers/{driverId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && (request.auth.uid == driverId || isAdmin());
      allow update: if isAuthenticated() && (request.auth.uid == driverId || isAdmin());
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // üìã PLATS DE COMMANDE
    // ==========================================
    match /orderDishes/{orderDishId} {
      allow read, write: if isAuthenticated();
    }

    // ==========================================
    // üí∞ TRANSACTIONS (AJOUT√â POUR WALLET)
    // ==========================================
    match /transactions/{transactionId} {
      // L'utilisateur peut lire ses propres transactions
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // L'utilisateur peut cr√©er une transaction SI l'ID correspond au sien
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Personne ne peut modifier ou supprimer une transaction (S√ªr)
      allow update, delete: if false; 
    }
  }
}
